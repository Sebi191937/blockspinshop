const adminUser = "sebi191937";
let currentUser = null;
let currentChat = null;

function saveUsers(users) {
  localStorage.setItem("users", JSON.stringify(users));
}

function getUsers() {
  return JSON.parse(localStorage.getItem("users")) || {};
}

function login() {
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value.trim();

  if (!username || !password) {
    document.getElementById("error").innerText = "Completa todos los campos.";
    return;
  }

  const users = getUsers();
  
  if (!users[username]) {
    users[username] = { password: password, messages: [] };
    saveUsers(users);
  }

  if (users[username].password === password) {
    currentUser = username;
    document.getElementById("login-container").classList.add("hidden");
    document.getElementById("main-container").classList.remove("hidden");
    document.getElementById("welcome").innerText = username === adminUser ? `Bienvenido Vendedor (${adminUser})` : `Bienvenido ${username}`;
    
    if (currentUser === adminUser) {
      document.querySelector(".admin-only").classList.remove("hidden");
      loadClients();
    }
  } else {
    document.getElementById("error").innerText = "Contraseña incorrecta.";
  }
}

function logout() {
  currentUser = null;
  location.reload();
}

function showSection(sectionId) {
  document.querySelectorAll("section").forEach(sec => sec.classList.add("hidden"));
  document.getElementById(sectionId).classList.remove("hidden");
}

function addToCart(product, quantity) {
  alert(`Producto añadido al carrito: ${product} x${quantity}`);
  sendEmailNotification(product, quantity);
}

function sendEmailNotification(product, quantity) {
  console.log(`Simulando envío a Gmail: ${product} x${quantity}`);
}

function sendMessage() {
  const msgInput = document.getElementById("messageInput");
  const msg = msgInput.value.trim();
  if (!msg) return;

  const users = getUsers();
  if (!users[currentUser]) return;

  users[currentUser].messages.push({ from: currentUser, text: msg });
  saveUsers(users);

  if (currentUser !== adminUser) {
    registerClient(currentUser);
  }

  msgInput.value = "";
  loadMessages(currentChat || currentUser);
  loadClients();
}

function loadMessages(user) {
  currentChat = user;
  const messagesDiv = document.getElementById("messages");
  messagesDiv.innerHTML = "";

  const users = getUsers();
  const messages = users[user]?.messages || [];

  document.getElementById("chat-with").innerText = `Chateando con: ${user}`;

  messages.forEach(m => {
    const msgEl = document.createElement("div");
    msgEl.innerText = `${m.from}: ${m.text}`;
    messagesDiv.appendChild(msgEl);
  });
}

function clearChat() {
  const users = getUsers();
  if (!currentChat) return;
  users[currentChat].messages = [];
  saveUsers(users);
  loadMessages(currentChat);
}

function registerClient(username) {
  let clients = JSON.parse(localStorage.getItem("clients")) || [];
  if (!clients.includes(username)) {
    clients.push(username);
    localStorage.setItem("clients", JSON.stringify(clients));
  }
}

function loadClients() {
  const clients = JSON.parse(localStorage.getItem("clients")) || [];
  const clientsList = document.getElementById("clients");
  clientsList.innerHTML = "";

  clients.forEach(client => {
    const li = document.createElement("li");
    li.innerText = client;
    li.onclick = () => loadMessages(client);
    clientsList.appendChild(li);
  });
}


